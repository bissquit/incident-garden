openapi: 3.0.3
info:
  title: StatusPage API
  description: API for managing service statuses and incidents
  version: 2.4.0
  contact:
    name: API Support
servers:
  - url: /
    description: Relative paths (for testing)
  - url: http://localhost:8080
    description: Local development
tags:
  - name: auth
    description: Authentication and session management
  - name: services
    description: Service management
  - name: groups
    description: Service group management
  - name: events
    description: Event management (incidents and maintenance)
  - name: templates
    description: Event templates
  - name: channels
    description: User notification channels
  - name: subscriptions
    description: Notification subscriptions
  - name: status
    description: Public status
paths:
  /healthz:
    get:
      summary: Liveness probe
      operationId: healthz
      responses:
        '200':
          description: OK
          content:
            text/plain:
              schema:
                type: string
                example: OK
  /readyz:
    get:
      summary: Readiness probe
      operationId: readyz
      responses:
        '200':
          description: Ready
          content:
            text/plain:
              schema:
                type: string
                example: OK
        '503':
          description: Not ready
  /api/v1/auth/register:
    post:
      tags: [auth]
      summary: Register a new user
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          $ref: '#/components/responses/ConflictError'
  /api/v1/auth/login:
    post:
      tags: [auth]
      summary: Log in to the system
      description: |
        Authenticates user and sets HTTP-only cookies for tokens.

        **Cookies set:**
        - `access_token` - JWT access token (HttpOnly, Secure, SameSite=Lax)
        - `refresh_token` - JWT refresh token (HttpOnly, Secure, SameSite=Strict, Path=/api/v1/auth)
        - `csrf_token` - CSRF token for subsequent requests (readable by JavaScript)
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful. Tokens are set via Set-Cookie headers.
          headers:
            Set-Cookie:
              description: Authentication cookies (access_token, refresh_token, csrf_token)
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /api/v1/auth/refresh:
    post:
      tags: [auth]
      summary: Refresh tokens
      description: |
        Refreshes authentication tokens using the refresh_token cookie.
        New tokens are set via Set-Cookie headers.

        **For cookie-based auth:** No request body needed, refresh_token is read from cookie.
        **For API clients:** Can pass refresh_token in request body.
      operationId: refreshTokens
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '204':
          description: Tokens refreshed. New tokens are set via Set-Cookie headers.
          headers:
            Set-Cookie:
              description: New authentication cookies
              schema:
                type: string
        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /api/v1/auth/logout:
    post:
      tags: [auth]
      summary: Log out from the system
      description: |
        Invalidates the refresh token and clears all authentication cookies.

        **For cookie-based auth:** No request body needed, refresh_token is read from cookie.
        **For API clients:** Can pass refresh_token in request body.
      operationId: logout
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '204':
          description: Logout successful. Cookies are cleared via Set-Cookie headers.
          headers:
            Set-Cookie:
              description: Cleared authentication cookies (Max-Age=0)
              schema:
                type: string
  /api/v1/me:
    get:
      tags: [auth]
      summary: Get current user
      operationId: getCurrentUser
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /api/v1/services:
    get:
      tags: [services]
      summary: List services
      description: Public endpoint, no authentication required
      operationId: listServices
      parameters:
        - name: group_id
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by group membership
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/ServiceStatus'
        - name: include_archived
          in: query
          schema:
            type: boolean
            default: false
          description: Include archived services in the response
      responses:
        '200':
          description: List of services
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServicesResponse'
    post:
      tags: [services]
      summary: Create a service
      operationId: createService
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateServiceRequest'
      responses:
        '201':
          description: Service created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '409':
          $ref: '#/components/responses/ConflictError'
  /api/v1/services/{slug}:
    get:
      tags: [services]
      summary: Get a service by slug
      operationId: getService
      parameters:
        - $ref: '#/components/parameters/ServiceSlug'
      responses:
        '200':
          description: Service data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
    patch:
      tags: [services]
      summary: Update a service
      operationId: updateService
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ServiceSlug'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateServiceRequest'
      responses:
        '200':
          description: Service updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
    delete:
      tags: [services]
      summary: Archive a service (soft delete)
      description: Archives the service. Returns 409 if service has active events (not resolved, completed, or scheduled).
      operationId: deleteService
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ServiceSlug'
      responses:
        '204':
          description: Service archived
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          $ref: '#/components/responses/ConflictError'
  /api/v1/services/{slug}/restore:
    post:
      tags: [services]
      summary: Restore an archived service
      operationId: restoreService
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ServiceSlug'
      responses:
        '200':
          description: Service restored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          $ref: '#/components/responses/ConflictError'
  /api/v1/services/{slug}/status-log:
    get:
      tags: [services]
      summary: Get service status change history
      description: |
        Returns the audit log of status changes for a service.
        Requires operator or admin role.

        Each entry shows:
        - What the status changed from/to
        - Source (manual, event, webhook)
        - Associated event (if applicable)
        - Who made the change
        - When it happened
      operationId: getServiceStatusLog
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ServiceSlug'
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Status change history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceStatusLogResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/v1/services/{slug}/events:
    get:
      tags: [services]
      summary: Get events for a service
      description: |
        Returns events (incidents and maintenance) associated with a service.
        This is a public endpoint, no authentication required.

        Events are sorted with active events first, then by creation date descending.
        Active events are those not resolved, completed, or scheduled.
      operationId: getServiceEvents
      parameters:
        - $ref: '#/components/parameters/ServiceSlug'
        - name: status
          in: query
          description: Filter by event status. Active excludes resolved, completed, and scheduled events.
          schema:
            type: string
            enum: [active, resolved]
          example: active
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Events for the service
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceEventsResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/v1/services/{slug}/tags:
    get:
      tags: [services]
      summary: Get service tags
      operationId: getServiceTags
      parameters:
        - $ref: '#/components/parameters/ServiceSlug'
      responses:
        '200':
          description: Service tags
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagsResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
    put:
      tags: [services]
      summary: Update service tags
      operationId: updateServiceTags
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ServiceSlug'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTagsRequest'
      responses:
        '200':
          description: Tags updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TagsResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/v1/groups:
    get:
      tags: [groups]
      summary: List groups
      operationId: listGroups
      parameters:
        - name: include_archived
          in: query
          schema:
            type: boolean
            default: false
          description: Include archived groups in the response
      responses:
        '200':
          description: List of groups
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupsResponse'
    post:
      tags: [groups]
      summary: Create a group
      operationId: createGroup
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGroupRequest'
      responses:
        '201':
          description: Group created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '409':
          $ref: '#/components/responses/ConflictError'
  /api/v1/groups/{slug}:
    get:
      tags: [groups]
      summary: Get a group by slug
      operationId: getGroup
      parameters:
        - $ref: '#/components/parameters/GroupSlug'
      responses:
        '200':
          description: Group data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
    patch:
      tags: [groups]
      summary: Update a group
      operationId: updateGroup
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/GroupSlug'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateGroupRequest'
      responses:
        '200':
          description: Group updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
    delete:
      tags: [groups]
      summary: Archive a group (soft delete)
      description: Archives the group. Returns 409 if group has active events (not resolved, completed, or scheduled) or has non-archived services assigned.
      operationId: deleteGroup
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/GroupSlug'
      responses:
        '204':
          description: Group archived
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          $ref: '#/components/responses/ConflictError'
  /api/v1/groups/{slug}/restore:
    post:
      tags: [groups]
      summary: Restore an archived group
      operationId: restoreGroup
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/GroupSlug'
      responses:
        '200':
          description: Group restored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          $ref: '#/components/responses/ConflictError'
  /api/v1/events:
    get:
      tags: [events]
      summary: List events
      description: Public endpoint, no authentication required
      operationId: listEvents
      parameters:
        - name: type
          in: query
          schema:
            $ref: '#/components/schemas/EventType'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/EventStatus'
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventsResponse'
    post:
      tags: [events]
      summary: Create an event
      description: |
        Creates an incident or maintenance event.

        **Service status assignment:**
        - Use `affected_services` to specify individual services with their statuses
        - Use `affected_groups` to assign the same status to all services in a group
        - If a service appears in both a group and `affected_services`, the explicit status takes precedence

        **Creating past events:**
        - Set `started_at` and `resolved_at` to dates in the past
        - Event will be created as already resolved
      operationId: createEvent
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEventRequest'
      responses:
        '201':
          description: Event created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
  /api/v1/events/{id}:
    get:
      tags: [events]
      summary: Get an event
      description: Public endpoint, no authentication required
      operationId: getEvent
      parameters:
        - $ref: '#/components/parameters/EventId'
      responses:
        '200':
          description: Event data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
    delete:
      tags: [events]
      summary: Delete an event
      description: |
        Deletes an event and all associated data.

        **Requirements:**
        - Requires admin role
        - Event must be resolved/completed (active events cannot be deleted)

        **What gets deleted:**
        - The event itself
        - All event updates
        - Service associations (event_services)
        - Group associations (event_groups)
        - Service change audit trail (event_service_changes)
        - Status log entries referencing this event

        **Note:** This is a destructive operation. The event and its history
        will be permanently removed. Consider if you really need to delete
        rather than just keeping the resolved event in history.
      operationId: deleteEvent
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/EventId'
      responses:
        '204':
          description: Event deleted successfully
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          description: Cannot delete active event
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "cannot delete active event: resolve it first"
  /api/v1/events/{id}/updates:
    get:
      tags: [events]
      summary: List event updates
      description: Public endpoint, no authentication required
      operationId: listEventUpdates
      parameters:
        - $ref: '#/components/parameters/EventId'
      responses:
        '200':
          description: List of updates
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventUpdatesResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
    post:
      tags: [events]
      summary: Add an update to an event
      description: |
        Adds a status update to an event and optionally modifies affected services.

        **Service modifications:**
        - `service_updates`: Change status of services already in the event
        - `add_services`: Add new services with specified statuses
        - `add_groups`: Add all services from groups with specified status
        - `remove_service_ids`: Remove services from the event

        **On event resolution:**
        When status is `resolved` or `completed`, affected services' stored status
        is recalculated. If a service has no other active events, it becomes `operational`.

        **Cannot update resolved events:**
        Returns 409 Conflict if the event is already resolved.
      operationId: addEventUpdate
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/EventId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddEventUpdateRequest'
      responses:
        '201':
          description: Update added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventUpdateResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          $ref: '#/components/responses/ConflictError'
  /api/v1/events/{id}/changes:
    get:
      tags: [events]
      summary: Get event service change history
      description: Public endpoint, no authentication required. Returns chronological list of all service/group additions and removals.
      operationId: getEventServiceChanges
      parameters:
        - $ref: '#/components/parameters/EventId'
      responses:
        '200':
          description: Change history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventServiceChangesResponse'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/v1/templates:
    get:
      tags: [templates]
      summary: List templates
      operationId: listTemplates
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of templates
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplatesResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
    post:
      tags: [templates]
      summary: Create a template
      description: Requires admin role
      operationId: createTemplate
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTemplateRequest'
      responses:
        '201':
          description: Template created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplateResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
  /api/v1/templates/{slug}:
    get:
      tags: [templates]
      summary: Get a template
      operationId: getTemplate
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TemplateSlug'
      responses:
        '200':
          description: Template data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TemplateResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/v1/templates/{slug}/preview:
    post:
      tags: [templates]
      summary: Preview a template
      operationId: previewTemplate
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/TemplateSlug'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PreviewTemplateRequest'
      responses:
        '200':
          description: Rendering result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PreviewTemplateResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/v1/templates/{id}:
    delete:
      tags: [templates]
      summary: Delete a template
      operationId: deleteTemplate
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Template deleted
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/v1/me/channels:
    get:
      tags: [channels]
      summary: My notification channels
      operationId: listMyChannels
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of channels
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChannelsResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    post:
      tags: [channels]
      summary: Add a notification channel
      operationId: createChannel
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateChannelRequest'
      responses:
        '201':
          description: Channel created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChannelResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
  /api/v1/me/channels/{id}:
    patch:
      tags: [channels]
      summary: Update a channel
      operationId: updateChannel
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ChannelId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateChannelRequest'
      responses:
        '200':
          description: Channel updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChannelResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
    delete:
      tags: [channels]
      summary: Delete a channel
      operationId: deleteChannel
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ChannelId'
      responses:
        '204':
          description: Channel deleted
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/v1/me/channels/{id}/verify:
    post:
      tags: [channels]
      summary: Verify a channel
      operationId: verifyChannel
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ChannelId'
      responses:
        '200':
          description: Channel verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChannelResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/v1/me/subscriptions:
    get:
      tags: [subscriptions]
      summary: My subscription
      operationId: getMySubscription
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Subscription data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    post:
      tags: [subscriptions]
      summary: Create or update a subscription
      operationId: updateSubscription
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateSubscriptionRequest'
      responses:
        '200':
          description: Subscription updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
    delete:
      tags: [subscriptions]
      summary: Delete a subscription
      operationId: deleteSubscription
      security:
        - BearerAuth: []
      responses:
        '204':
          description: Subscription deleted
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'
  /api/v1/status:
    get:
      tags: [status]
      summary: Current public status
      operationId: getPublicStatus
      responses:
        '200':
          description: Current system status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicStatusResponse'
  /api/v1/status/history:
    get:
      tags: [status]
      summary: Event history
      operationId: getStatusHistory
      responses:
        '200':
          description: Event history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicStatusResponse'
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        For API clients (curl, Postman, integrations).
        Pass the access token in the Authorization header.
    CookieAuth:
      type: apiKey
      in: cookie
      name: access_token
      description: |
        For browser-based clients.
        Cookies are automatically set by /auth/login and sent by the browser.
        State-changing requests (POST, PUT, PATCH, DELETE) require X-CSRF-Token header
        matching the csrf_token cookie value.
  parameters:
    ServiceSlug:
      name: slug
      in: path
      required: true
      schema:
        type: string
    GroupSlug:
      name: slug
      in: path
      required: true
      schema:
        type: string
    EventId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    TemplateSlug:
      name: slug
      in: path
      required: true
      schema:
        type: string
    ChannelId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message:
                    type: string
                  details:
                    oneOf:
                      - type: array
                        items:
                          type: object
                          properties:
                            field:
                              type: string
                            message:
                              type: string
                          required: [field, message]
                      - type: string
                    description: Validation error details. Array of field errors or error string.
    UnauthorizedError:
      description: Authentication required
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message:
                    type: string
    ForbiddenError:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message:
                    type: string
    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message:
                    type: string
    ConflictError:
      description: Conflict
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: object
                properties:
                  message:
                    type: string
  schemas:
    ServiceStatus:
      type: string
      enum: [operational, degraded, partial_outage, major_outage, maintenance]
    EventType:
      type: string
      enum: [incident, maintenance]
    EventStatus:
      type: string
      enum: [investigating, identified, monitoring, resolved, scheduled, in_progress, completed]
    Severity:
      type: string
      enum: [minor, major, critical]
    ChangeAction:
      type: string
      enum: [added, removed]
    StatusLogSourceType:
      type: string
      enum: [manual, event, webhook]
      description: Source of the status change
    ChannelType:
      type: string
      enum: [email, telegram]
    Role:
      type: string
      enum: [user, operator, admin]
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        first_name:
          type: string
        last_name:
          type: string
        role:
          $ref: '#/components/schemas/Role'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required: [id, email, role, created_at, updated_at]
    Service:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        status:
          $ref: '#/components/schemas/ServiceStatus'
          description: Stored status (set manually or by closed events)
        effective_status:
          $ref: '#/components/schemas/ServiceStatus'
          description: Effective status (worst-case from active events, or stored if no active events). Active events exclude resolved, completed, and scheduled.
        has_active_events:
          type: boolean
          description: Whether the service has any active events (not resolved, completed, or scheduled)
        group_ids:
          type: array
          items:
            type: string
            format: uuid
        order:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        archived_at:
          type: string
          format: date-time
          nullable: true
      required: [id, name, slug, status, effective_status, has_active_events, group_ids, order, created_at, updated_at]
    ServiceGroup:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        description:
          type: string
        service_ids:
          type: array
          items:
            type: string
            format: uuid
        order:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        archived_at:
          type: string
          format: date-time
          nullable: true
      required: [id, name, slug, service_ids, order, created_at, updated_at]
    Event:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        type:
          $ref: '#/components/schemas/EventType'
        status:
          $ref: '#/components/schemas/EventStatus'
        severity:
          allOf:
            - $ref: '#/components/schemas/Severity'
          nullable: true
        description:
          type: string
        started_at:
          type: string
          format: date-time
          nullable: true
        resolved_at:
          type: string
          format: date-time
          nullable: true
        scheduled_start_at:
          type: string
          format: date-time
          nullable: true
        scheduled_end_at:
          type: string
          format: date-time
          nullable: true
        notify_subscribers:
          type: boolean
        template_id:
          type: string
          format: uuid
          nullable: true
        created_by:
          type: string
          format: uuid
        service_ids:
          type: array
          items:
            type: string
            format: uuid
          nullable: true
        group_ids:
          type: array
          items:
            type: string
            format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required: [id, title, type, status, description, notify_subscribers, created_by, created_at, updated_at]
    EventUpdate:
      type: object
      properties:
        id:
          type: string
          format: uuid
        event_id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/EventStatus'
        message:
          type: string
        notify_subscribers:
          type: boolean
        created_by:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
      required: [id, event_id, status, message, notify_subscribers, created_by, created_at]
    EventServiceChange:
      type: object
      properties:
        id:
          type: string
          format: uuid
        event_id:
          type: string
          format: uuid
        batch_id:
          type: string
          format: uuid
          nullable: true
          description: Groups changes made in a single operation. Null for legacy records.
        action:
          $ref: '#/components/schemas/ChangeAction'
        service_id:
          type: string
          format: uuid
          nullable: true
        group_id:
          type: string
          format: uuid
          nullable: true
        reason:
          type: string
        created_by:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
      required: [id, event_id, action, created_by, created_at]
    EventTemplate:
      type: object
      properties:
        id:
          type: string
          format: uuid
        slug:
          type: string
        type:
          $ref: '#/components/schemas/EventType'
        title_template:
          type: string
        body_template:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required: [id, slug, type, title_template, body_template, created_at, updated_at]
    NotificationChannel:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        type:
          $ref: '#/components/schemas/ChannelType'
        target:
          type: string
        is_enabled:
          type: boolean
        is_verified:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required: [id, user_id, type, target, is_enabled, is_verified, created_at, updated_at]
    Subscription:
      type: object
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        service_ids:
          type: array
          items:
            type: string
            format: uuid
        created_at:
          type: string
          format: date-time
      required: [id, user_id, service_ids, created_at]
    TokenPair:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in:
          type: integer
      required: [access_token, refresh_token, expires_in]
    RegisterRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        first_name:
          type: string
        last_name:
          type: string
      required: [email, password]
    LoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
      required: [email, password]
    RefreshRequest:
      type: object
      properties:
        refresh_token:
          type: string
      required: [refresh_token]
    CreateServiceRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        slug:
          type: string
          minLength: 1
          maxLength: 255
          pattern: '^[a-z0-9]+(?:-[a-z0-9]+)*$'
        description:
          type: string
        status:
          $ref: '#/components/schemas/ServiceStatus'
        group_ids:
          type: array
          items:
            type: string
            format: uuid
        order:
          type: integer
          default: 0
        tags:
          type: object
          additionalProperties:
            type: string
      required: [name, slug]
    UpdateServiceRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        slug:
          type: string
          minLength: 1
          maxLength: 255
          pattern: '^[a-z0-9]+(?:-[a-z0-9]+)*$'
        description:
          type: string
        status:
          $ref: '#/components/schemas/ServiceStatus'
        group_ids:
          type: array
          items:
            type: string
            format: uuid
        order:
          type: integer
        reason:
          type: string
          description: Reason for status change (recorded in audit log)
      required: [name, slug, status]
    UpdateTagsRequest:
      type: object
      properties:
        tags:
          type: object
          additionalProperties:
            type: string
      required: [tags]
    CreateGroupRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        slug:
          type: string
          minLength: 1
          maxLength: 255
          pattern: '^[a-z0-9]+(?:-[a-z0-9]+)*$'
        description:
          type: string
        order:
          type: integer
          default: 0
      required: [name, slug]
    UpdateGroupRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        slug:
          type: string
          minLength: 1
          maxLength: 255
          pattern: '^[a-z0-9]+(?:-[a-z0-9]+)*$'
        description:
          type: string
        order:
          type: integer
        service_ids:
          type: array
          items:
            type: string
            format: uuid
          description: List of service IDs to assign to this group. If provided, replaces all existing service memberships.
      required: [name, slug]
    AffectedService:
      type: object
      description: Service to associate with an event and its status
      properties:
        service_id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/ServiceStatus'
      required: [service_id, status]
    AffectedGroup:
      type: object
      description: Group whose services will be associated with an event
      properties:
        group_id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/ServiceStatus'
          description: Status to apply to ALL services in this group
      required: [group_id, status]
    CreateEventRequest:
      type: object
      properties:
        title:
          type: string
          minLength: 1
        type:
          $ref: '#/components/schemas/EventType'
        status:
          $ref: '#/components/schemas/EventStatus'
        severity:
          $ref: '#/components/schemas/Severity'
          description: Required for incidents
        description:
          type: string
        started_at:
          type: string
          format: date-time
        resolved_at:
          type: string
          format: date-time
          description: For creating past events (already resolved)
        scheduled_start_at:
          type: string
          format: date-time
        scheduled_end_at:
          type: string
          format: date-time
        notify_subscribers:
          type: boolean
          default: false
        template_id:
          type: string
          format: uuid
        affected_services:
          type: array
          description: Services to associate with this event
          items:
            $ref: '#/components/schemas/AffectedService'
        affected_groups:
          type: array
          description: Groups whose services to associate with this event
          items:
            $ref: '#/components/schemas/AffectedGroup'
      required: [title, type, status, description]
    AddEventUpdateRequest:
      type: object
      properties:
        status:
          $ref: '#/components/schemas/EventStatus'
        message:
          type: string
          minLength: 1
        notify_subscribers:
          type: boolean
          default: false
        service_updates:
          type: array
          description: Update statuses of services already in this event
          items:
            $ref: '#/components/schemas/AffectedService'
        add_services:
          type: array
          description: Add new services to this event
          items:
            $ref: '#/components/schemas/AffectedService'
        add_groups:
          type: array
          description: Add all services from these groups to this event
          items:
            $ref: '#/components/schemas/AffectedGroup'
        remove_service_ids:
          type: array
          description: Remove services from this event
          items:
            type: string
            format: uuid
        reason:
          type: string
          description: Reason for service changes (for audit log)
      required: [status, message]
    CreateTemplateRequest:
      type: object
      properties:
        slug:
          type: string
          pattern: '^[a-z0-9]+(?:-[a-z0-9]+)*$'
        type:
          $ref: '#/components/schemas/EventType'
        title_template:
          type: string
        body_template:
          type: string
      required: [slug, type, title_template, body_template]
    PreviewTemplateRequest:
      type: object
      properties:
        service_name:
          type: string
        service_group_name:
          type: string
        started_at:
          type: string
          format: date-time
        resolved_at:
          type: string
          format: date-time
        scheduled_start:
          type: string
          format: date-time
        scheduled_end:
          type: string
          format: date-time
    CreateChannelRequest:
      type: object
      properties:
        type:
          $ref: '#/components/schemas/ChannelType'
        target:
          type: string
      required: [type, target]
    UpdateChannelRequest:
      type: object
      properties:
        is_enabled:
          type: boolean
      required: [is_enabled]
    UpdateSubscriptionRequest:
      type: object
      properties:
        service_ids:
          type: array
          items:
            type: string
            format: uuid
    UserResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/User'
    LoginResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            user:
              $ref: '#/components/schemas/User'
    ServiceResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Service'
    ServicesResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Service'
    GroupResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/ServiceGroup'
    GroupsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/ServiceGroup'
    EventResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Event'
    EventsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Event'
    EventUpdateResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/EventUpdate'
    EventUpdatesResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/EventUpdate'
    EventServiceChangesResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/EventServiceChange'
    TemplateResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/EventTemplate'
    TemplatesResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/EventTemplate'
    PreviewTemplateResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            title:
              type: string
            body:
              type: string
    ChannelResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/NotificationChannel'
    ChannelsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/NotificationChannel'
    SubscriptionResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Subscription'
    TagsResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            tags:
              type: object
              additionalProperties:
                type: string
    ServiceStatusLogEntry:
      type: object
      properties:
        id:
          type: string
          format: uuid
        service_id:
          type: string
          format: uuid
        old_status:
          allOf:
            - $ref: '#/components/schemas/ServiceStatus'
          nullable: true
        new_status:
          $ref: '#/components/schemas/ServiceStatus'
        source_type:
          $ref: '#/components/schemas/StatusLogSourceType'
        event_id:
          type: string
          format: uuid
          nullable: true
        reason:
          type: string
        created_by:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
      required: [id, service_id, new_status, source_type, created_by, created_at]
    ServiceStatusLogResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            entries:
              type: array
              items:
                $ref: '#/components/schemas/ServiceStatusLogEntry'
            total:
              type: integer
            limit:
              type: integer
            offset:
              type: integer
    ServiceEventsResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            events:
              type: array
              items:
                $ref: '#/components/schemas/Event'
            total:
              type: integer
              description: Total number of events matching the filter
            limit:
              type: integer
            offset:
              type: integer
    PublicStatusResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            events:
              type: array
              items:
                $ref: '#/components/schemas/Event'
